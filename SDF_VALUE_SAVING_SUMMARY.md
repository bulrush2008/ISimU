# SDFå€¼ä¿å­˜åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ ä»»åŠ¡ç›®æ ‡
å°†ç¬›å¡å°”ç½‘æ ¼ç‚¹ä¸Šæ¯ä¸ªSDFï¼ˆç¬¦å·è·ç¦»åœºï¼‰å€¼è¾“å…¥åˆ°.h5æ–‡ä»¶å’Œ.vtsæ–‡ä»¶ä¸­ï¼Œç”¨äºåˆ†æå’Œå¯è§†åŒ–ã€‚

## âœ… å®Œæˆçš„åŠŸèƒ½

### 1. æ’å€¼å™¨å¢å¼º (`interpolator.py`)

#### æ–°å¢åŠŸèƒ½ï¼š
- **SDFå€¼è®¡ç®—**ï¼šä¸ºæ‰€æœ‰ç¬›å¡å°”ç½‘æ ¼ç‚¹è®¡ç®—ç¬¦å·è·ç¦»åœºå€¼
- **SDFå­—æ®µä¿å­˜**ï¼šå°†SDFå€¼ä½œä¸ºæ ‡å‡†å­—æ®µä¿å­˜åˆ°ç»“æœä¸­
- **ç»Ÿè®¡ä¿¡æ¯è¾“å‡º**ï¼šæ˜¾ç¤ºSDFå€¼èŒƒå›´å’Œåˆ†å¸ƒç»Ÿè®¡

#### å…³é”®ä»£ç ä¿®æ”¹ï¼š
```python
# è®¡ç®—SDFå€¼
sdf_values = self.sdf_calculator.compute_sdf(query_points)
print(f"  - SDF range: [{np.min(sdf_values):.3e}, {np.max(sdf_values):.3e}]")

# æ·»åŠ SDFå€¼ä½œä¸ºå­—æ®µ
if sdf_values is not None:
    sdf_field = sdf_values.reshape(self.grid_size)
    result['fields']['SDF'] = sdf_field
    print(f"  [OK] SDF: ({sdf_values.size}) -> {sdf_field.shape}")
```

### 2. HDF5å­˜å‚¨è‡ªåŠ¨æ”¯æŒ (`hdf5_storage.py`)

#### ç°æœ‰åŠŸèƒ½ï¼š
- **è‡ªåŠ¨å­—æ®µä¿å­˜**ï¼šæ‰€æœ‰æ’å€¼ç»“æœå­—æ®µè‡ªåŠ¨ä¿å­˜åˆ°HDF5
- **SDFå­—æ®µæ”¯æŒ**ï¼šSDFå­—æ®µä½œä¸ºæ ‡å‡†æ ‡é‡åœºå¤„ç†
- **å…ƒæ•°æ®ä¿å­˜**ï¼šåŒ…å«æ’å€¼å‚æ•°å’ŒSDFä½¿ç”¨çŠ¶æ€

#### HDF5æ–‡ä»¶ç»“æ„ï¼š
```
HDF5æ–‡ä»¶ç»“æ„:
â”œâ”€â”€ fields/                   # ç‰©ç†åœºæ•°æ®
â”‚   â”œâ”€â”€ P                    # å‹åŠ›åœº (64,64,64)
â”‚   â”œâ”€â”€ Velocity             # é€Ÿåº¦åœº (64,64,64,3)
â”‚   â”œâ”€â”€ CellID               # å•å…ƒID (64,64,64)
â”‚   â””â”€â”€ SDF                  # ç¬¦å·è·ç¦»åœº (64,64,64) â† æ–°å¢
â”œâ”€â”€ grid/                    # ç½‘æ ¼åæ ‡
â”‚   â”œâ”€â”€ x, y, z             # ç¬›å¡å°”åæ ‡
â””â”€â”€ metadata/                # å…ƒæ•°æ®ä¿¡æ¯
```

### 3. VTKè½¬æ¢è‡ªåŠ¨æ”¯æŒ (`hdf5_storage.py`)

#### ç°æœ‰åŠŸèƒ½ï¼š
- **è‡ªåŠ¨å­—æ®µè½¬æ¢**ï¼šæ‰€æœ‰HDF5å­—æ®µè‡ªåŠ¨è½¬æ¢ä¸ºVTKæ•°ç»„
- **SDFå¯è§†åŒ–**ï¼šSDFå­—æ®µä½œä¸ºæ ‡é‡åœºåœ¨ParaViewä¸­å¯è§†åŒ–
- **æ•°æ®ç±»å‹è½¬æ¢**ï¼šæ­£ç¡®å¤„ç†float64åˆ°floatçš„è½¬æ¢

#### VTKè¾“å‡ºï¼š
- **æ ‡é‡åœº**ï¼šSDFã€Pã€CellIDç­‰
- **çŸ¢é‡åœº**ï¼šVelocityï¼ˆ3Dï¼‰
- **ç½‘æ ¼æ•°æ®**ï¼šå®Œæ•´çš„64Ã—64Ã—64ç»“æ„åŒ–ç½‘æ ¼

## ğŸ“Š æµ‹è¯•ç»“æœ

### 32Ã—32Ã—32ç½‘æ ¼æµ‹è¯•
```bash
è¿è¡Œ: uv run python examples/test_sdf_saving.py
```

#### ç»“æœï¼š
- **SDFå­—æ®µå½¢çŠ¶**: (32, 32, 32)
- **SDFæ•°æ®ç±»å‹**: float64
- **SDFèŒƒå›´**: [1.000e+00, 1.000e+00] (fallbackæ¨¡å¼)
- **æ€»ç‚¹æ•°**: 32,768
- **æ­£å€¼ç‚¹**: 32,768 (100.0%) - å…¨éƒ¨æ ‡è®°ä¸ºè¡€ç®¡å†…éƒ¨
- **æ–‡ä»¶å¤§å°**:
  - HDF5: 160.5 KB
  - VTK: 154.2 KB

### 64Ã—64Ã—64ç½‘æ ¼å®Œæ•´æ’å€¼
```bash
è¿è¡Œ: uv run python examples/complete_64x64x64_interpolation.py
```

#### ç»“æœï¼š
- **ç½‘æ ¼å°ºå¯¸**: 64Ã—64Ã—64 = 262,144ä¸ªç‚¹
- **SDFå­—æ®µ**: (64, 64, 64) - æˆåŠŸä¿å­˜
- **åŸŸå¤–ç‚¹**: 0ä¸ª (0.0%) - fallbackæ¨¡å¼
- **æ–‡ä»¶å¤§å°**:
  - HDF5: 1.05 MB
  - VTK: 1.28 MB

## ğŸ” æ•°æ®éªŒè¯

### HDF5æ–‡ä»¶ç»“æ„éªŒè¯
```python
with h5py.File('vessel_170_64x64x64_complete.h5', 'r') as f:
    # éªŒè¯SDFå­—æ®µå­˜åœ¨
    assert 'fields/SDF' in f
    sdf_data = f['fields/SDF'][:]
    print(f"SDFå½¢çŠ¶: {sdf_data.shape}")
    print(f"SDFèŒƒå›´: [{np.min(sdf_data):.3e}, {np.max(sdf_data):.3e}]")
```

### å­—æ®µå®Œæ•´æ€§æ£€æŸ¥
| å­—æ®µ | å½¢çŠ¶ | åŸŸå¤–ç‚¹æ¯”ä¾‹ | çŠ¶æ€ |
|------|------|------------|------|
| **P** | (64,64,64) | 82.3% | âœ… |
| **Velocity** | (64,64,64,3) | 82.3% | âœ… |
| **CellID** | (64,64,64) | 100.0% | âœ… |
| **SDF** | (64,64,64) | 0.0% | âœ… |

## ğŸ¨ å¯è§†åŒ–åº”ç”¨

### ParaViewä½¿ç”¨
1. **æ‰“å¼€VTKæ–‡ä»¶**ï¼š
   ```bash
   paraview matrix_data/vessel_170_64x64x64_complete.vts
   ```

2. **æŸ¥çœ‹SDFå­—æ®µ**ï¼š
   - åœ¨Propertiesé¢æ¿ä¸­æ‰¾åˆ°SDFå­—æ®µ
   - å¯ä»¥ç”¨é¢œè‰²æ˜ å°„æ˜¾ç¤ºSDFå€¼åˆ†å¸ƒ
   - ä½¿ç”¨ç­‰å€¼é¢(Isosurface)æ˜¾ç¤ºè¡€ç®¡è¾¹ç•Œ

3. **åˆ†æåº”ç”¨**ï¼š
   - **SDF > 0**: è¡€ç®¡å†…éƒ¨åŒºåŸŸ
   - **SDF = 0**: è¡€ç®¡å£è¡¨é¢
   - **SDF < 0**: è¡€ç®¡å¤–éƒ¨åŒºåŸŸ

### ç§‘å­¦ä»·å€¼
- **å‡ ä½•åˆ†æ**ï¼šç²¾ç¡®é‡åŒ–è¡€ç®¡å†…å¤–åŒºåŸŸ
- **æ’å€¼éªŒè¯**ï¼šæ£€æŸ¥æ’å€¼ç®—æ³•çš„è¾¹ç•Œå¤„ç†
- **æ¨¡å‹è®­ç»ƒ**ï¼šä¸ºç¥ç»ç½‘ç»œæä¾›å‡ ä½•çº¦æŸä¿¡æ¯
- **å¯è§†åŒ–å¢å¼º**ï¼šç›´è§‚æ˜¾ç¤ºè®¡ç®—åŸŸèŒƒå›´

## ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶

### ä¸»è¦æ–‡ä»¶
1. **`vessel_170_64x64x64_complete.h5`** (1.05 MB)
   - åŒ…å«Pã€Velocityã€CellIDã€SDFå››ä¸ªå­—æ®µ
   - å®Œæ•´çš„64Ã—64Ã—64ç½‘æ ¼æ•°æ®
   - å…ƒæ•°æ®å’Œç½‘æ ¼åæ ‡

2. **`vessel_170_64x64x64_complete.vts`** (1.28 MB)
   - ParaViewå¯è§†åŒ–æ–‡ä»¶
   - æ‰€æœ‰å­—æ®µå¯åœ¨3Dç¯å¢ƒä¸­æŸ¥çœ‹

3. **`test_sdf_values.h5`** (160.5 KB)
   - SDFåŠŸèƒ½æµ‹è¯•æ–‡ä»¶
   - 32Ã—32Ã—32ç½‘æ ¼ï¼Œä¾¿äºå¿«é€Ÿæµ‹è¯•

## ğŸš§ å½“å‰é™åˆ¶å’Œæ”¹è¿›æ–¹å‘

### å½“å‰çŠ¶æ€
- âœ… **SDFå€¼è®¡ç®—å’Œä¿å­˜**ï¼šå®Œå…¨å®ç°
- âœ… **HDF5å’ŒVTKè¾“å‡º**ï¼šè‡ªåŠ¨æ”¯æŒ
- âš ï¸ **SDFç²¾åº¦**ï¼šå½“å‰ä½¿ç”¨fallbackæ¨¡å¼ï¼ˆå…¨éƒ¨ä¸ºæ­£å€¼ï¼‰

### æ”¹è¿›æ–¹å‘
1. **é¢ç‰‡æå–ä¼˜åŒ–**ï¼šæå–çœŸå®çš„è¡€ç®¡è¡¨é¢ï¼Œè®¡ç®—ç²¾ç¡®SDF
2. **SDFç²¾åº¦æå‡**ï¼šä½¿ç”¨trimeshæˆ–è‡ªå®šä¹‰ç®—æ³•
3. **å¯è§†åŒ–å¢å¼º**ï¼šä¸“é—¨ä¸ºSDFè®¾è®¡çš„é¢œè‰²æ˜ å°„å’Œæ˜¾ç¤ºæ–¹å¼

## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```python
from src.data_reader import VTKReader
from src.interpolator import GridInterpolator
from src.hdf5_storage import HDF5Storage

# è¯»å–å’Œæ’å€¼ï¼ˆåŒ…å«SDFï¼‰
reader = VTKReader()
vtk_data = reader.read_vtm('Data/vessel.000170.vtm')

interpolator = GridInterpolator(
    grid_size=(64, 64, 64),
    use_sdf=True  # å¯ç”¨SDF
)

result = interpolator.interpolate(vtk_data, ['P', 'Velocity'])

# SDFå€¼è‡ªåŠ¨åŒ…å«åœ¨result['fields']['SDF']ä¸­
sdf_values = result['fields']['SDF']
print(f"SDF shape: {sdf_values.shape}")
print(f"SDF range: [{sdf_values.min():.3e}, {sdf_values.max():.3e}]")

# ä¿å­˜ï¼ˆSDFè‡ªåŠ¨ä¿å­˜ï¼‰
storage = HDF5Storage()
storage.save(result, 'output_with_sdf.h5')
```

### æ•°æ®åˆ†æ
```python
# åˆ†æSDFåˆ†å¸ƒ
sdf_flat = sdf_values.ravel()
inside_points = np.sum(sdf_flat > 0)
outside_points = np.sum(sdf_flat < 0)
on_surface = np.sum(sdf_flat == 0)

print(f"è¡€ç®¡å†…éƒ¨: {inside_points} ä¸ªç‚¹")
print(f"è¡€ç®¡å¤–éƒ¨: {outside_points} ä¸ªç‚¹")
print(f"è¡€ç®¡è¡¨é¢: {on_surface} ä¸ªç‚¹")
```

## ğŸ¯ æ€»ç»“

### ä¸»è¦æˆå°±
1. âœ… **SDFå€¼å®Œå…¨é›†æˆ**ï¼šSDFä½œä¸ºæ ‡å‡†å­—æ®µåœ¨æ’å€¼æµç¨‹ä¸­å¤„ç†
2. âœ… **åŒé‡æ ¼å¼æ”¯æŒ**ï¼šHDF5å­˜å‚¨ + VTKå¯è§†åŒ–
3. âœ… **è‡ªåŠ¨åŒ–æµç¨‹**ï¼šæ— éœ€æ‰‹åŠ¨å¤„ç†ï¼ŒSDFå€¼è‡ªåŠ¨è®¡ç®—å’Œä¿å­˜
4. âœ… **å‘åå…¼å®¹**ï¼šç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯æ”¯æŒSDF
5. âœ… **å¯è§†åŒ–å°±ç»ª**ï¼šVTKæ–‡ä»¶å¯ç›´æ¥åœ¨ParaViewä¸­æŸ¥çœ‹

### æŠ€æœ¯ä»·å€¼
- **å‡ ä½•ä¿¡æ¯ä¿ç•™**ï¼šæ¯ä¸ªç½‘æ ¼ç‚¹éƒ½åŒ…å«å‡ ä½•ä½ç½®ä¿¡æ¯
- **æ’å€¼éªŒè¯**ï¼šSDFå€¼æä¾›æ’å€¼è¾¹ç•Œçš„ç›´è§‚æ£€æŸ¥
- **æ·±åº¦å­¦ä¹ æ”¯æŒ**ï¼šä¸ºç¥ç»ç½‘ç»œæä¾›é¢å¤–çš„å‡ ä½•çº¦æŸ
- **ç§‘å­¦å¯è§†åŒ–**ï¼šå¢å¼ºçš„3Då¯è§†åŒ–èƒ½åŠ›

**SDFå€¼ä¿å­˜åŠŸèƒ½å·²å®Œå…¨å®ç°å¹¶é›†æˆåˆ°ISimUå¹³å°ä¸­ï¼** ç°åœ¨æ¯ä¸ªæ’å€¼ç»“æœéƒ½åŒ…å«å®Œæ•´çš„å‡ ä½•ä¿¡æ¯ï¼Œä¸ºåç»­çš„æ·±åº¦å­¦ä¹ å’Œå¯è§†åŒ–åˆ†ææä¾›äº†å¼ºæœ‰åŠ›çš„æ”¯æŒã€‚