# ISimU 项目文档

## 项目概述
ISimU (Intelligent Simulation for UNS) 是一个基于深度学习的CFD代理模型开发平台，旨在通过UNS（基于非结构网格的CFD求解器）的仿真结果训练神经网络，构建能够快速预测流场的智能代理模型。

## 项目需求

### 1. 项目类型
- 项目性质：CFD代理模型开发平台 / 深度学习驱动的仿真加速工具
- 应用领域：计算流体动力学、机器学习、科学计算、高性能计算、血管流动力学快速仿真

### 2. 核心功能

#### 模块一：矩阵数据库功能
- **数据提取**：从UNS求解器的VTK格式仿真结果中提取流场数据。目前的数据格式为vtm, vtu
- **网格插值**：将非结构网格数据插值到均匀笛卡尔网格上
  - **设置方法**：默认使用临近最近的网格直接赋值，用户可以选择使用临界的3个网格的平均值进行插值
  - **几何尺寸**：
    - 几何数据：Data/geo/portal_vein_A.stl，缩放比例0.001
    - 流场数据：位于Data/vtm文件，及关联的vtu文件，非结构网格
    - 笛卡尔网格：参照vtm流场数据的尺寸，基于按比例缩放后的stl几何文件
  - **网格规模**：用于插值的笛卡尔网格默认为$64\times 64\times 64$
  - **区域区分**：对于任意笛卡尔网格点，如果处于血管内部（$\phi>0$），使用原数据插值；如果处于血管外部（$\phi<0$），直接赋值"0"（压力P=0，速度=(0,0,0)）
  - **插值步骤**：
    1. 计算符号距离SDF值$\phi$。SDF是Signed Distance Function的缩写。$|\phi|$绝对值表示距离血管壁的距离；$\phi>0$表示位于血管内部，需要使用血管流数据进行插值；$\phi<0$表示位于血管外，不进行插值，直接赋值0
    2. 根据$\phi$的符号，进行插值。血管内部$\phi>0$，使用流场数据插值；血管外部$\phi<0$，直接赋值0
- **数据存储**：将插值后的数据存储为HDF5格式的矩阵数据
- **数据管理**：建立索引和组织大量CFD仿真数据集
- **数据显示**：将矩阵数据转化为VTK数据，能在paraview上显示

#### 模块二：深度学习代理模型
- **模型开发**：构建卷积神经网络架构学习流场特征
- **模型训练**：使用矩阵数据库中的HDF5数据训练代理模型
- **快速预测**：实现毫秒级的流场预测，替代昂贵CFD计算
- **模型评估**：评估代理模型的预测精度和泛化能力

### 3. 技术要求
- **编程语言**：Python
- **数据处理库**：
  - VTK：读取和处理UNS的VTK格式结果
  - NumPy/SciPy：数值计算和插值算法
  - h5py：HDF5文件读写
  - pandas：数据管理和索引
- **深度学习框架**：PyTorch / TensorFlow
- **数据格式**：
  - 输入：VTK格式（UNS求解器结果）
  - 输出：HDF5格式（矩阵数据库）
- **插值算法**：线性插值、径向基函数插值等，插值算法可有第三方Python库提供

### 4. 数据说明
- **VTM文件格式**：
  - UNS求解器的多块数据集输出格式
  - 包含流场变量：速度、压力、温度等
  - 非结构网格拓扑和几何信息
- **数据来源**：
  - UNS CFD求解器的仿真结果
  - 当前示例：vessel.000170.vtm（时间步170的结果）
- **数据处理流程**：
  1. 读取VTK多块数据集
  2. 提取流场物理量（速度场、压力场等）
  3. 插值到均匀笛卡尔网格
  4. 转换为矩阵形式存储为HDF5

### 5. 性能要求
- **计算规模**：
  - 单个算例：48×48×48网格（~11万点）到128×128×128网格（~200万点）
  - 数据库规模：数百个CFD算例的批量处理
  - 性能目标：单个算例处理时间从数十秒优化到数秒
- **硬件资源**：
  - CPU：多核处理器，支持并行计算
  - 内存：支持大规模数组的内存管理
  - GPU：可选，用于大规模计算加速
- **性能优化方向**：
  - **算法优化**：使用LinearNDInterpolator替代重复的griddata调用
  - **并行计算**：多进程SDF计算，多线程插值处理
  - **GPU加速**：使用CuPy和RAPIDS进行GPU计算
  - **内存优化**：流式处理，数据类型优化，批处理大小调优

### 6. 项目目标
- **短期目标**：完成非结构网格的读取和插值工作
  - 实现VTK格式文件的读取功能
  - 开发非结构网格到均匀笛卡尔网格的插值算法
  - 实现插值结果的HDF5格式存储
  - 实现插值结果可视化，比如vts格式文件
- **中期目标**：构建完整的矩阵数据库系统
  - 批量处理多个VTK文件
  - 建立数据索引和管理系统
  - 实现矩阵数据的可视化功能
  - **性能优化**：实现插值算法的性能优化，支持大规模数据处理
- **长期目标**：开发深度学习代理模型
  - 设计CNN网络架构
  - 训练流场预测模型
  - 实现快速预测和评估系统

## 当前状态
- 已有数据：vessel.000170.vtm 等血管流相关数据
- Git 历史：第一次提交已准备算例数据x1
- 开发环境：Windows 环境
- 已实现功能：
  - VTK/VTM文件读取功能
  - STL几何文件处理（支持0.001缩放）
  - 基于STL的SDF计算（内部>0，外部<0）
  - 域外点赋零策略（P=0，Velocity=(0,0,0)）
  - 压力P和速度V的插值计算
  - 多尺度网格支持（16×16×16到48×48×48）
  - HDF5存储和VTK可视化
- 性能瓶颈：
  - 48×48×48网格（11万点）计算时间过长
  - SDF计算串行处理，效率低
  - scipy.griddata重复调用，构建开销大

## 下一步计划
### 性能优化阶段
1. [ ] **算法优化**：重构插值器，使用LinearNDInterpolator预构建
2. [ ] **并行计算**：实施多进程SDF计算和多线程插值
3. [ ] **内存优化**：优化数据类型和批处理策略
4. [ ] **性能测试**：建立基准测试，量化优化效果
### 功能扩展阶段
5. [ ] **批量处理**：支持多个VTK文件的自动化处理
6. [ ] **GPU加速**：可选的GPU计算支持
7. [ ] **深度学习模型**：开发CNN代理模型
8. [ ] **系统集成**：完整的端到端工作流

---
*此文档将持续更新，记录项目的发展和需求变化*