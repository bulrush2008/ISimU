# ISimU 项目文档

## 项目概述
ISimU (Intelligent Simulation for UNS) 是一个基于深度学习的CFD代理模型开发平台，旨在通过UNS（基于非结构网格的CFD求解器）的仿真结果训练神经网络，构建能够快速预测流场的智能代理模型。

## 🚫 重要限制和禁止项

### Git操作限制
- **严禁任何自动git操作**：包括但不限于`git add`、`git commit`、`git push`、`git pull`、`git merge`等
- **git权限**：所有git操作必须由人工手动执行
- **版本控制**：代码更改完成后，由开发者自行决定是否提交到版本控制系统
- **分支管理**：禁止自动创建、切换或合并分支
- **标签操作**：禁止自动创建或删除git标签

## 项目需求

### 1. 项目类型
- 项目性质：CFD代理模型开发平台 / 深度学习驱动的仿真加速工具
- 应用领域：计算流体动力学、机器学习、科学计算、高性能计算、血管流动力学快速仿真

### 2. 核心功能

#### 模块一：矩阵数据库功能
- **数据提取**：从UNS求解器的VTK格式仿真结果中提取流场数据。目前的数据格式为vtm, vtu
- **网格插值**：将非结构网格数据插值到均匀笛卡尔网格上
  - **设置方法**：默认使用临近最近的网格直接赋值，用户可以选择使用临界的3个网格的平均值进行插值
  - **几何尺寸**：
    - 几何数据：Data/geo/portal_vein_A.stl，缩放比例0.001
    - 流场数据：位于Data/vtm文件，及关联的vtu文件，非结构网格
    - 笛卡尔网格：参照vtm流场数据的尺寸，基于按比例缩放后的stl几何文件
  - **网格规模**：用于插值的笛卡尔网格默认为$64\times 64\times 64$
  - **区域区分**：对于任意笛卡尔网格点，如果处于血管内部（$\phi>0$），使用原数据插值；如果处于血管外部（$\phi<0$），直接赋值"0"（压力P=0，速度=(0,0,0)）
  - **插值步骤**：
    1. 计算符号距离SDF值$\phi$。SDF是Signed Distance Function的缩写。$|\phi|$绝对值表示距离血管壁的距离；$\phi>0$表示位于血管内部，需要使用血管流数据进行插值；$\phi<0$表示位于血管外，不进行插值，直接赋值0
    2. 根据$\phi$的符号，进行插值。血管内部$\phi>0$，使用流场数据插值；血管外部$\phi<0$，直接赋值0
- **数据存储**：将插值后的数据存储为HDF5格式的矩阵数据
- **数据管理**：建立索引和组织大量CFD仿真数据集
- **数据显示**：将矩阵数据转化为VTK数据，能在paraview上显示

#### 模块二：深度学习代理模型
- **模型开发**：构建卷积神经网络架构学习流场特征
- **模型训练**：使用矩阵数据库中的HDF5数据训练代理模型
- **快速预测**：实现毫秒级的流场预测，替代昂贵CFD计算
- **模型评估**：评估代理模型的预测精度和泛化能力

### 3. 技术要求
- **编程语言**：Python
- **数据处理库**：
  - VTK：读取和处理UNS的VTK格式结果
  - NumPy/SciPy：数值计算和插值算法
  - h5py：HDF5文件读写
  - pandas：数据管理和索引
- **深度学习框架**：PyTorch / TensorFlow
- **数据格式**：
  - 输入：VTK格式（UNS求解器结果）
  - 输出：HDF5格式（矩阵数据库）
- **插值算法**：线性插值、径向基函数插值等，插值算法可有第三方Python库提供
- **MCP工具集成**：
  - **webSearchPrime**：联网搜索工具，提供网络信息检索功能
    - 功能：搜索网络信息，返回网页标题、URL、摘要、网站名称、图标等
    - 用途：技术文档查询、性能优化方案调研、最新算法研究
  - **视觉理解工具**：多媒体内容分析
    - image_analysis：图像分析工具，支持多种格式，提供详细视觉描述
    - video_analysis：视频分析工具，支持多种格式，提供详细视觉内容分析
    - 用途：CFD结果可视化分析、流场图像理解、仿真视频处理

### 4. 数据说明
- **VTM文件格式**：
  - UNS求解器的多块数据集输出格式
  - 包含流场变量：速度、压力、温度等
  - 非结构网格拓扑和几何信息
- **数据来源**：
  - UNS CFD求解器的仿真结果
  - 当前示例：vessel.000170.vtm（时间步170的结果）
- **数据处理流程**：
  1. 读取VTK多块数据集
  2. 提取流场物理量（速度场、压力场等）
  3. 插值到均匀笛卡尔网格
  4. 转换为矩阵形式存储为HDF5

### 5. 性能要求
- **计算规模**：
  - 单个算例：48×48×48网格（~11万点）到128×128×128网格（~200万点）
  - 数据库规模：数百个CFD算例的批量处理
  - 性能目标：单个算例处理时间从数十秒优化到数秒
- **硬件资源**：
  - CPU：多核处理器，支持并行计算
  - 内存：支持大规模数组的内存管理
  - GPU：可选，用于大规模计算加速
- **性能优化方向**：
  - **算法优化**：使用LinearNDInterpolator替代重复的griddata调用
  - **并行计算**：多进程SDF计算，多线程插值处理
  - **GPU加速**：使用CuPy和RAPIDS进行GPU计算
  - **内存优化**：流式处理，数据类型优化，批处理大小调优

### 6. 项目目标
- **短期目标**：完成非结构网格的读取和插值工作
  - 实现VTK格式文件的读取功能
  - 开发非结构网格到均匀笛卡尔网格的插值算法
  - 实现插值结果的HDF5格式存储
  - 实现插值结果可视化，比如vts格式文件
- **中期目标**：构建完整的矩阵数据库系统
  - 批量处理多个VTK文件
  - 建立数据索引和管理系统
  - 实现矩阵数据的可视化功能
  - **性能优化**：实现插值算法的性能优化，支持大规模数据处理
- **长期目标**：开发深度学习代理模型
  - 设计CNN网络架构
  - 训练流场预测模型
  - 实现快速预测和评估系统

## 当前状态（更新至最新版本）

### 📊 项目进展
- **已有数据**：vessel.000170.vtm 等血管流相关数据，以及portal_vein_A.stl几何文件
- **环境管理**：采用uv配置环境，支持Windows/Linux/macOS
- **核心功能完备**：VTK/VTM读取、STL几何处理、SDF计算、智能插值、多格式输出

### ✅ 已完成的关键功能
- ✅ **VTK/VTM文件读取**：完整支持UNS求解器输出格式
- ✅ **STL几何处理**：支持0.001缩放，自动路径检测
- ✅ **精确SDF计算**：基于trimesh的符号距离场（内部>0，外部<0）
- ✅ **智能插值策略**：血管内部插值，外部赋零（P=0，Velocity=(0,0,0)）
- ✅ **多物理场支持**：压力、速度、CellID、SDF字段
- ✅ **多尺度网格**：16³到64³网格支持
- ✅ **HDF5存储**：结构化数据存储和VTK可视化
- ✅ **内存优化**：批处理机制支持大规模计算

### 🚀 性能优化成果（已完成）
- ✅ **消除SDF重复计算**：修复重复计算BUG，实现1.67x性能提升
- ✅ **算法优化**：使用LinearNDInterpolator替代重复griddata调用
- ✅ **优化版本**：interpolator_optimized.py已实现并测试
- ✅ **批处理优化**：增大批处理大小提升效率

### 📈 性能基准
| 网格规模 | 优化前 | 优化后 | 性能提升 | 状态 |
|----------|--------|--------|----------|------|
| **48³ (11万点)** | 15分钟 | 9分钟 | **1.67x** | ✅ 已完成 |
| **64³ (26万点)** | 25-30分钟 | 15-18分钟 | **1.67x** | ✅ 已完成 |

### 🚧 当前性能瓶颈和优化方向
- **并行化需求**：SDF计算和插值处理仍为串行
- **进一步优化目标**：48³网格目标2-3分钟，需3-5x提升
- **扩展性考虑**：128³大规模网格需要GPU加速支持

### 📁 生成的数据文件
- `matrix_data/dense_48x48x48_zero_assignment.h5/vts`：48³密集网格结果
- `matrix_data/dense_64x64x64_zero_assignment.h5/vts`：64³超密集网格结果
- `matrix_data/perf_analysis_*.h5/vts`：性能分析数据

## 下一步计划

### 🚀 性能优化阶段（当前重点，高优先级）
1. [✅] **算法优化**：重构插值器，使用LinearNDInterpolator预构建
2. [🚧] **并行计算**：实施多进程SDF计算和多线程插值
3. [🚧] **批处理优化**：增大批处理大小，减少函数调用开销
4. [📋] **性能基准**：建立完整的性能评估体系

### 📊 量化目标
- **48³网格**：从9分钟→2-3分钟（3-5x提升）
- **64³网格**：从15-18分钟→5-8分钟（3-4x提升）
- **并行效率**：目标CPU利用率>80%

### 🔧 功能扩展阶段（中优先级）
5. [📋] **批量处理系统**：支持多个VTK文件的自动化处理
6. [📋] **配置化管理**：YAML/JSON配置文件驱动
7. [📋] **数据验证**：插值精度评估和可视化验证
8. [📋] **错误处理**：完善的异常处理和日志系统

### 🧠 深度学习阶段（长期目标）
9. [📋] **GPU加速支持**：CuPy+RAPIDS（可选，预期10-50x加速）
10. [📋] **CNN代理模型**：开发3D CNN流场预测网络
11. [📋] **模型训练**：使用HDF5矩阵数据库训练
12. [📋] **实时预测**：毫秒级流场预测API

### 📁 项目文档整理
- ✅ **文档迁移**：技术文档已迁移至docs/目录
- ✅ **README更新**：反映最新项目状态和性能基准
- ✅ **CLAUDE.md更新**：同步项目进展和优化成果

---

## 🚀 新增数据源支持计划 (VMR数据)

### 📊 **背景**
项目将从单一的STL+VTU数据源(data_UNS/)扩展到支持VTP+VTU数据源(data_VMR/)，需要新增对VTP格式几何文件的支持。

### 🎯 **关键技术要点**
- **无缩放需求**：VMR数据的几何和流场之间不存在缩放关系，缩放比例=1
- **格式变更**：从STL格式 → VTP格式 (VTK多边形数据)
- **配置驱动**：通过`data_VMR/geo-flow.json`管理7个算例
- **向后兼容**：保持对STL格式(data_UNS/)的完全支持

### 📋 **详细实施计划**

#### **阶段1：分析阶段**
1. [ ] **分析新数据结构和格式差异**
   - 读取并理解geo-flow.json配置文件
   - 分析VTP vs STL格式差异
   - 检查VTP文件结构和内容
   - 确定坐标系统和缩放(比例=1)

2. [ ] **设计新的几何文件读取器架构**
   - 设计支持多格式(STL/VTP)的统一接口
   - 确定数据结构和API设计
   - 考虑向后兼容性

#### **阶段2：实现阶段**
3. [ ] **实现VTP几何读取器**
   - 创建`vtp_reader.py`模块
   - 实现VTP文件读取和解析
   - 处理顶点和面片数据提取
   - 错误处理和数据验证

4. [ ] **修改SDF计算器支持VTP**
   - 更新`sdf_utils.py`以支持VTP输入
   - 保持STL兼容性（双格式支持）
   - 统一SDF计算接口

5. [ ] **创建VMR数据加载器**
   - 实现`vmr_data_loader.py`
   - 解析geo-flow.json配置
   - 统一加载VTP几何和VTU流场数据

6. [ ] **更新插值器支持新数据**
   - 修改`interpolator_optimized.py`
   - 集成新的数据加载流程
   - 确保插值逻辑正确

#### **阶段3：测试阶段**
7. [ ] **测试单个算例**
   - 选择第一个算例(0007_H_AO_H)进行测试
   - 验证VTP读取和SDF计算
   - 运行完整插值流程
   - 对比结果与预期

8. [ ] **实现批量处理**
   - 支持geo-flow.json中的7个算例
   - 实现批量插值处理
   - 性能测试和优化

#### **阶段4：完善阶段**
9. [ ] **更新文档和示例**
   - 更新README说明新数据流程
   - 创建VTP格式的示例代码
   - 更新CLAUDE.md项目文档

### 🔧 **技术考虑**

**新增数据源结构：**
```json
{
    "0007_H_AO_H": {
        "geo": "data_VMR/0007_H_AO_H/Simulations/0090_0001/check/initial.vtp",
        "flow": "data_VMR/0007_H_AO_H/Simulations/0090_0001/mesh-complete/initial.vtu"
    },
    // ... 总共7个算例
}
```

**关键技术变更：**
- **几何格式**：STL → VTP (不需要trimesh，直接用VTK)
- **缩放处理**：0.001(STL) → 1.0(VTP，无需缩放)
- **数据配置**：固定路径 → JSON配置驱动
- **批量处理**：单个文件 → 7个算例批量

**预期影响：**
- ✅ **扩展性**：支持更多数据源格式
- ✅ **灵活性**：配置驱动的批量处理
- ✅ **兼容性**：保持STL格式的完整支持
- ✅ **标准化**：统一的数据加载接口

---
*此文档将持续更新，记录项目的发展和需求变化*